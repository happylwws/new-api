name: CI Workflow

on: 
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs: 
  build: 
    runs-on: ubuntu-20.04
    strategy: 
      matrix: 
        language: ["go", "node", "python"]
        python-version: ["3.9", "3.10"] # 仅在 Python 构建时使用

    steps: 
      - uses: actions/checkout@v3

      # 针对不同语言的设置和构建
      - name: Set up environment
        run: |
          if [ "${{ matrix.language }}" == "python" ]; then
            echo "Setting up Python ${{ matrix.python-version }}"
          elif [ "${{ matrix.language }}" == "go" ]; then
            echo "Setting up Go environment"
            sudo apt-get install -y golang
          elif [ "${{ matrix.language }}" == "node" ]; then
            echo "Setting up Node.js environment"
            curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi

      # 设置 Python 版本
      - name: Set up Python ${{ matrix.python-version }}
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # 安装 Python 依赖
      - name: Install Python dependencies
        if: matrix.language == 'python'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 安装 Go 依赖
      - name: Install Go dependencies
        if: matrix.language == 'go'
        run: |
          if [ -f go.mod ]; then go mod download; fi

      # 安装 Node.js 依赖
      - name: Install Node.js dependencies
        if: matrix.language == 'node'
        run: |
          if [ -f package.json ]; then npm install; fi

      # Docker 登录
      - name: Docker login
        uses: docker/login-action@v2
        with: 
          username: "${{ secrets.DOCKERHUB_USERNAME }}"
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 构建 Docker 镜像
      - name: Build the Docker image
        run: docker build --file Dockerfile -t happylwws/newapi:latest .

      # 推送 Docker 镜像
      - name: Docker image push
        run: docker push happylwws/newapi:latest
